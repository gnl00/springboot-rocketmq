# Level 4 å¿«é€Ÿæµ‹è¯•æŒ‡å—

## ðŸŽ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯æ¶ˆæ¯ç§¯åŽ‹é—®é¢˜åŠä¼˜åŒ–æ•ˆæžœï¼š
- **Buggy ç‰ˆæœ¬**ï¼š2 msg/sï¼Œä¸¥é‡ç§¯åŽ‹
- **Best ç‰ˆæœ¬**ï¼š200+ msg/sï¼Œæ— ç§¯åŽ‹

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åº”ç”¨
```bash
cd sb-mq-producer
mvn spring-boot:run
```

---

## ðŸ“‹ æµ‹è¯•åœºæ™¯

### åœºæ™¯ Aï¼šæµ‹è¯• Buggy ç‰ˆæœ¬ï¼ˆæ¼”ç¤ºç§¯åŽ‹é—®é¢˜ï¼‰

#### æ­¥éª¤ 1ï¼šå‘é€æ¶ˆæ¯è§‚å¯Ÿç§¯åŽ‹

```bash
# 1. å¿«é€Ÿå‘é€ 1000 æ¡æ¶ˆæ¯ï¼ˆé€ŸçŽ‡ 100 msg/sï¼‰
curl "http://localhost:8070/challenge/level4/produceMessages?count=1000&ratePerSecond=100"

# è¿”å›žï¼šâœ… å·²å¼€å§‹å‘é€æ¶ˆæ¯ - æ€»æ•°: 1000, ç›®æ ‡é€ŸçŽ‡: 100 msg/s

# 2. è§‚å¯Ÿç”Ÿäº§è€…æ—¥å¿—
# ðŸ“¤ å·²å‘é€: 100 æ¡, é€ŸçŽ‡: 100.00 msg/s
# ðŸ“¤ å·²å‘é€: 200 æ¡, é€ŸçŽ‡: 100.00 msg/s
# ...
# âœ… æ¶ˆæ¯å‘é€å®Œæˆ - æˆåŠŸ: 1000, å¤±è´¥: 0, æ€»è€—æ—¶: 10000 ms, å¹³å‡é€ŸçŽ‡: 100.00 msg/s

# 3. è§‚å¯Ÿæ¶ˆè´¹è€…æ—¥å¿—ï¼ˆBuggy ç‰ˆæœ¬ï¼‰
# ðŸ“Š æ¶ˆè´¹ç»Ÿè®¡ - å·²æ¶ˆè´¹: 100 æ¡, è€—æ—¶: 50000 ms, é€ŸçŽ‡: 2.00 msg/s
# ðŸ“Š æ¶ˆè´¹ç»Ÿè®¡ - å·²æ¶ˆè´¹: 200 æ¡, è€—æ—¶: 100000 ms, é€ŸçŽ‡: 2.00 msg/s
```

**ç»“è®ºï¼š**
- ç”Ÿäº§å®Œæˆæ—¶é—´ï¼š10 ç§’ï¼ˆ1000 æ¡ Ã· 100 msg/sï¼‰
- æ¶ˆè´¹å®Œæˆæ—¶é—´ï¼š500 ç§’ï¼ˆ1000 æ¡ Ã· 2 msg/sï¼‰
- **ç§¯åŽ‹ 490 ç§’ï¼**

#### æ­¥éª¤ 2ï¼šæŒç»­å‘é€è§‚å¯Ÿç§¯åŽ‹å¢žé•¿

```bash
# æŒç»­å‘é€ 60 ç§’ï¼Œé€ŸçŽ‡ 100 msg/s
curl "http://localhost:8070/challenge/level4/continuousProduce?ratePerSecond=100&durationSeconds=60"

# è¿”å›žï¼šâœ… å·²å¼€å§‹æŒç»­å‘é€ - é€ŸçŽ‡: 100 msg/s, æŒç»­: 60 ç§’

# ç­‰å¾… 60 ç§’...

# è®¡ç®—ç§¯åŽ‹ï¼š
# å‘é€æ•°é‡ï¼š100 msg/s Ã— 60s = 6000 æ¡
# æ¶ˆè´¹æ•°é‡ï¼š2 msg/s Ã— 60s = 120 æ¡
# ç§¯åŽ‹æ•°é‡ï¼š6000 - 120 = 5880 æ¡ âŒ
```

#### æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç§¯åŽ‹è¯´æ˜Ž

```bash
curl "http://localhost:8070/challenge/level4/checkBacklog"
```

è¾“å‡ºï¼š
```
ðŸ’¡ æŸ¥çœ‹æ¶ˆæ¯ç§¯åŽ‹çš„æ–¹æ³•ï¼š

1. ä½¿ç”¨ RocketMQ Dashboard:
   http://localhost:8080 (å¦‚æžœéƒ¨ç½²äº† Dashboard)

2. ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·:
   mqadmin consumerProgress -g notification-consumer-buggy

3. è§‚å¯Ÿæ—¥å¿—ä¸­çš„æ¶ˆè´¹é€ŸçŽ‡:
   - ç”Ÿäº§é€ŸçŽ‡: 100 msg/s
   - æ¶ˆè´¹é€ŸçŽ‡: 2 msg/s
   - ç§¯åŽ‹é€Ÿåº¦: 98 msg/s

4. è®¡ç®—ç§¯åŽ‹æ•°é‡:
   å¦‚æžœæŒç»­ 60 ç§’ = 98 Ã— 60 = 5880 æ¡ç§¯åŽ‹
```

---

### åœºæ™¯ Bï¼šæµ‹è¯• Best ç‰ˆæœ¬ï¼ˆä¼˜åŒ–æ•ˆæžœï¼‰

**æ³¨æ„ï¼š** Best ç‰ˆæœ¬ä½¿ç”¨ä¸åŒçš„ tag å’Œ consumerGroupï¼š
- Tag: `best`
- ConsumerGroup: `notification-consumer-best`

#### åˆ›å»º Best ç‰ˆæœ¬çš„ç”Ÿäº§è€…

ä½ éœ€è¦ä¿®æ”¹ `Level4Producer.java` æˆ–åˆ›å»ºæ–°çš„æŽ¥å£ï¼Œå‘é€ tag ä¸º `best` çš„æ¶ˆæ¯ã€‚

**ä¸´æ—¶æ–¹æ¡ˆï¼š** ä¿®æ”¹ `Level4Producer.java` ä¸­çš„ tagï¼š

```java
// åŽŸæ¥
.setTag("order-created")

// æ”¹ä¸º
.setTag("best")
```

æˆ–è€…åˆ›å»ºæ–°çš„æŽ¥å£ï¼š

```java
@GetMapping("/produceMessagesBest")
public String produceMessagesBest(@RequestParam(defaultValue = "1000") int count) {
    // ... ä»£ç ç±»ä¼¼ï¼Œä½† tag æ”¹ä¸º "best"
}
```

#### æµ‹è¯•ä¼˜åŒ–æ•ˆæžœ

```bash
# 1. å‘é€ 1000 æ¡æ¶ˆæ¯ï¼ˆtag ä¸º bestï¼‰
curl "http://localhost:8070/challenge/level4/produceMessages?count=1000&ratePerSecond=100"

# 2. è§‚å¯Ÿæ¶ˆè´¹è€…æ—¥å¿—ï¼ˆBest ç‰ˆæœ¬ï¼‰
# ðŸš€ æ¶ˆè´¹ç»Ÿè®¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰- å·²æ¶ˆè´¹: 100 æ¡, è€—æ—¶: 500 ms, é€ŸçŽ‡: 200.00 msg/s
# ðŸš€ æ¶ˆè´¹ç»Ÿè®¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰- å·²æ¶ˆè´¹: 200 æ¡, è€—æ—¶: 1000 ms, é€ŸçŽ‡: 200.00 msg/s
```

**å¯¹æ¯”ï¼š**
| ç‰ˆæœ¬ | æ¶ˆè´¹é€ŸçŽ‡ | 1000 æ¡è€—æ—¶ | ç»“æžœ |
|------|---------|------------|------|
| Buggy | 2 msg/s | 500 ç§’ | âŒ ä¸¥é‡ç§¯åŽ‹ |
| Best | 200 msg/s | 5 ç§’ | âœ… æ— ç§¯åŽ‹ |

---

## ðŸ“Š æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### æµ‹è¯• 1ï¼šæ¶ˆè´¹é€ŸçŽ‡å¯¹æ¯”

```bash
# Buggy ç‰ˆæœ¬
# è§‚å¯Ÿæ—¥å¿— 10 ç§’ï¼Œç»Ÿè®¡æ¶ˆè´¹æ•°é‡
# é¢„æœŸï¼šçº¦ 20 æ¡ï¼ˆ2 msg/s Ã— 10sï¼‰

# Best ç‰ˆæœ¬
# è§‚å¯Ÿæ—¥å¿— 10 ç§’ï¼Œç»Ÿè®¡æ¶ˆè´¹æ•°é‡
# é¢„æœŸï¼šçº¦ 2000 æ¡ï¼ˆ200 msg/s Ã— 10sï¼‰
```

### æµ‹è¯• 2ï¼šç§¯åŽ‹æ¢å¤æµ‹è¯•

```bash
# 1. å…ˆç”¨ Buggy ç‰ˆæœ¬åˆ¶é€  5000 æ¡ç§¯åŽ‹
curl "http://localhost:8070/challenge/level4/produceMessages?count=5000&ratePerSecond=200"

# 2. åœæ­¢å‘é€
curl "http://localhost:8070/challenge/level4/stop"

# 3. è§‚å¯Ÿç§¯åŽ‹æ¢å¤æ—¶é—´
# Buggy ç‰ˆæœ¬ï¼š5000 Ã· 2 = 2500 ç§’ = 41.6 åˆ†é’Ÿ âŒ
# Best ç‰ˆæœ¬ï¼š5000 Ã· 200 = 25 ç§’ âœ…
```

---

## ðŸ” é—®é¢˜æŽ’æŸ¥æŠ€å·§

### 1. æŸ¥çœ‹æ¶ˆè´¹çº¿ç¨‹æ•°

```bash
# ä½¿ç”¨ JConsole æˆ– VisualVM è¿žæŽ¥åº”ç”¨
# è§‚å¯Ÿçº¿ç¨‹æ•°é‡ï¼š
# - Buggy ç‰ˆæœ¬ï¼š1-2 ä¸ª RocketMQ æ¶ˆè´¹çº¿ç¨‹
# - Best ç‰ˆæœ¬ï¼š20-50 ä¸ªæ¶ˆè´¹çº¿ç¨‹
```

### 2. ç›‘æŽ§ CPU ä½¿ç”¨çŽ‡

```bash
# Buggy ç‰ˆæœ¬ï¼šCPU ä½¿ç”¨çŽ‡ä½Žï¼ˆ10-20%ï¼‰
# åŽŸå› ï¼šå•çº¿ç¨‹å¤„ç†ï¼Œå¤§éƒ¨åˆ†æ—¶é—´åœ¨ sleep

# Best ç‰ˆæœ¬ï¼šCPU ä½¿ç”¨çŽ‡é«˜ï¼ˆ60-80%ï¼‰
# åŽŸå› ï¼šå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†
```

### 3. è§‚å¯Ÿå†…å­˜ä½¿ç”¨

```bash
# å¦‚æžœç§¯åŽ‹è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å‡é«˜
# RocketMQ ä¼šå°†æ¶ˆæ¯ç¼“å­˜åœ¨å†…å­˜ä¸­
```

---

## ðŸŽ“ å­¦ä¹ è¦ç‚¹

### 1. è¯†åˆ«ç§¯åŽ‹

**æŒ‡æ ‡ï¼š**
- æ¶ˆæ¯å †ç§¯æ•°é‡ï¼ˆConsumer Lagï¼‰
- æ¶ˆè´¹é€ŸçŽ‡ vs ç”Ÿäº§é€ŸçŽ‡
- æ¶ˆæ¯æ¶ˆè´¹å»¶è¿Ÿ

**å·¥å…·ï¼š**
- RocketMQ Dashboard
- `mqadmin consumerProgress` å‘½ä»¤
- åº”ç”¨æ—¥å¿—

### 2. åˆ†æžç“¶é¢ˆ

**é—®é¢˜ç±»åž‹ï¼š**
1. **æ¶ˆè´¹é€»è¾‘æ…¢**ï¼šä¸šåŠ¡å¤„ç†è€—æ—¶
2. **æ¶ˆè´¹çº¿ç¨‹å°‘**ï¼šå¹¶å‘åº¦ä¸è¶³
3. **é˜»å¡žæ“ä½œå¤š**ï¼šåŒæ­¥è°ƒç”¨ã€IO ç­‰å¾…
4. **èµ„æºä¸è¶³**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œ

**åˆ†æžæ–¹æ³•ï¼š**
1. æŸ¥çœ‹å•æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´
2. æŸ¥çœ‹æ¶ˆè´¹çº¿ç¨‹æ•°é‡
3. åˆ†æžä¸šåŠ¡ä»£ç è€—æ—¶ç‚¹
4. ç›‘æŽ§ç³»ç»Ÿèµ„æºä½¿ç”¨çŽ‡

### 3. ä¼˜åŒ–ç­–ç•¥

**å¿«é€Ÿä¼˜åŒ–ï¼ˆç«‹å³è§æ•ˆï¼‰ï¼š**
1. å¢žåŠ æ¶ˆè´¹çº¿ç¨‹æ•°
2. å¢žåŠ æ¶ˆè´¹è€…å®žä¾‹
3. ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘

**æ·±åº¦ä¼˜åŒ–ï¼ˆæŒç»­æ”¹è¿›ï¼‰ï¼š**
1. å¼‚æ­¥åŒ–å¤„ç†
2. æ‰¹é‡å¤„ç†
3. ç¼“å­˜ä¼˜åŒ–
4. æ•°æ®åº“ä¼˜åŒ–

---

## ðŸ’¡ ç”Ÿäº§çŽ¯å¢ƒå»ºè®®

### 1. å®¹é‡è§„åˆ’

```
æ¶ˆè´¹èƒ½åŠ› = å•çº¿ç¨‹å¤„ç†é€ŸçŽ‡ Ã— çº¿ç¨‹æ•° Ã— å®žä¾‹æ•°

ç¤ºä¾‹ï¼š
å•çº¿ç¨‹ï¼š10 msg/s
çº¿ç¨‹æ•°ï¼š20
å®žä¾‹æ•°ï¼š5
æ¶ˆè´¹èƒ½åŠ›ï¼š10 Ã— 20 Ã— 5 = 1000 msg/s
```

### 2. é¢„ç•™ä½™é‡

```
æ¶ˆè´¹èƒ½åŠ›åº”è¯¥æ˜¯ç”Ÿäº§é€ŸçŽ‡çš„ 1.5-2 å€

ç¤ºä¾‹ï¼š
ç”Ÿäº§é€ŸçŽ‡ï¼š100 msg/s
æ¶ˆè´¹èƒ½åŠ›ï¼š150-200 msg/sï¼ˆé¢„ç•™ 50-100%ï¼‰
```

### 3. ç›‘æŽ§å‘Šè­¦

```java
// ç§¯åŽ‹æ•°é‡å‘Šè­¦
if (backlogCount > 1000) {
    alert("æ¶ˆæ¯ç§¯åŽ‹ï¼š" + backlogCount);
}

// æ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦
if (consumeDelay > 60000) {  // è¶…è¿‡ 1 åˆ†é’Ÿ
    alert("æ¶ˆè´¹å»¶è¿Ÿï¼š" + consumeDelay + "ms");
}

// æ¶ˆè´¹é€ŸçŽ‡å‘Šè­¦
if (consumeRate < produceRate * 0.8) {
    alert("æ¶ˆè´¹é€ŸçŽ‡è¿‡ä½Ž");
}
```

### 4. åº”æ€¥é¢„æ¡ˆ

```
1. ç´§æ€¥æ‰©å®¹ï¼šå¢žåŠ æ¶ˆè´¹è€…å®žä¾‹
2. ä¸šåŠ¡é™çº§ï¼šè·³è¿‡éžæ ¸å¿ƒé€»è¾‘
3. é™æµä¿æŠ¤ï¼šä¿æŠ¤ä¸‹æ¸¸ç³»ç»Ÿ
4. äººå·¥å¹²é¢„ï¼šæ¸…ç†æ— æ•ˆæ¶ˆæ¯
```

---

## âœ… éªŒæ”¶æ ‡å‡†

**Buggy ç‰ˆæœ¬ï¼š**
- âœ… æ¶ˆè´¹é€ŸçŽ‡ï¼š2 msg/s
- âŒ å‘é€ 1000 æ¡æ¶ˆæ¯åŽï¼Œç§¯åŽ‹ä¸¥é‡

**Best ç‰ˆæœ¬ï¼š**
- âœ… æ¶ˆè´¹é€ŸçŽ‡ï¼šâ‰¥ 100 msg/s
- âœ… å‘é€ 1000 æ¡æ¶ˆæ¯åŽï¼Œæ— ç§¯åŽ‹
- âœ… æŒç»­å‘é€ 60 ç§’ï¼Œç§¯åŽ‹å¯æŽ§

**ä¼˜ç§€æ ‡å‡†ï¼š**
- âœ… æ¶ˆè´¹é€ŸçŽ‡ï¼šâ‰¥ 200 msg/s
- âœ… ä¼˜åŒ–åŽåžåé‡æå‡ 100 å€

---

## ðŸŽ¯ æŒ‘æˆ˜ä»»åŠ¡

1. **åˆ†æžç“¶é¢ˆ**ï¼š
   - æ‰¾å‡º Buggy ç‰ˆæœ¬æ…¢çš„åŽŸå› 
   - è®¡ç®—ç†è®ºæœ€å¤§æ¶ˆè´¹é€ŸçŽ‡

2. **å®žçŽ°ä¼˜åŒ–**ï¼š
   - è‡³å°‘å®žçŽ° 2 ç§ä¼˜åŒ–æ–¹æ¡ˆ
   - å°†æ¶ˆè´¹é€ŸçŽ‡æå‡åˆ° 100+ msg/s

3. **æ€§èƒ½æµ‹è¯•**ï¼š
   - å¯¹æ¯”ä¼˜åŒ–å‰åŽçš„æ€§èƒ½
   - éªŒè¯æ— ç§¯åŽ‹

4. **æ–‡æ¡£è®°å½•**ï¼š
   - è®°å½•ä¼˜åŒ–æ€è·¯
   - æ€»ç»“æ€§èƒ½æå‡æ•°æ®

---

**å¼€å§‹ä½ çš„ä¼˜åŒ–æŒ‘æˆ˜å§ï¼** ðŸš€

ç›®æ ‡ï¼šå°†æ¶ˆè´¹é€ŸçŽ‡ä»Ž **2 msg/s** æå‡åˆ° **100+ msg/s**ï¼
